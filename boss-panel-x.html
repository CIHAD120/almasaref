<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>لوحة التحكم العليا | Live Admin</title>
    <link rel="stylesheet" href="assets/css/base.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background: #050505; color: #fff; padding: 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
        .card { background: #111; border: 1px solid #333; padding: 20px; border-radius: 12px; }
        .user-row { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #222; }
        .user-row:hover { background: #1a1a1a; }
        h2 { color: var(--primary); }
    </style>
</head>
<body>
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h1><span style="color:var(--danger)">●</span> المراقبة الحية (Firebase)</h1>
        <a href="dashboard.html" class="btn">عودة للموقع</a>
    </div>

    <div class="grid">
        <div class="card">
            <h3>إجمالي الأموال في النظام</h3>
            <h1 id="totalSystemMoney" style="color:var(--primary)">جاري التحميل...</h1>
        </div>
        <div class="card">
            <h3>عدد المستخدمين النشطين</h3>
            <h1 id="totalUsers">...</h1>
        </div>
    </div>

    <div class="card" style="margin-top: 20px;">
        <h3>سجل المستخدمين (Live)</h3>
        <div id="usersList" style="margin-top: 15px;">
            </div>
    </div>

    <script type="module">
        import { authInstance } from './assets/js/core/auth.js';
        import { dbInstance } from './assets/js/core/db.js';

        // تهيئة المصادقة
        authInstance.initAuth(async (user) => {
            if (!user) {
                window.location.href = 'auth.html';
                return;
            }
            
            // جلب البيانات
            loadLiveStats();
        });

        async function loadLiveStats() {
            // بما أنك الأدمن، هذه الدالة ستجلب بيانات "الجميع"
            const expenses = await dbInstance.getAll('expenses');
            const incomes = await dbInstance.getAll('income');

            // 1. تجميع البيانات حسب المستخدمين
            const usersMap = {};

            // معالجة الدخل
            incomes.forEach(inc => {
                if(!usersMap[inc.userId]) usersMap[inc.userId] = { income: 0, expense: 0, email: inc.userId };
                usersMap[inc.userId].income += parseFloat(inc.amount);
            });

            // معالجة المصروفات
            expenses.forEach(exp => {
                if(!usersMap[exp.userId]) usersMap[exp.userId] = { income: 0, expense: 0, email: exp.userId };
                usersMap[exp.userId].expense += parseFloat(exp.amount);
            });

            // 2. العرض في الشاشة
            let totalMoney = 0;
            const usersList = document.getElementById('usersList');
            usersList.innerHTML = `<div class="user-row" style="color:#888; font-weight:bold;">
                <span>المستخدم</span> <span>الدخل</span> <span>المصروف</span> <span>المتبقي</span>
            </div>`;

            Object.values(usersMap).forEach(u => {
                const balance = u.income - u.expense;
                totalMoney += balance;
                
                const div = document.createElement('div');
                div.className = 'user-row';
                div.innerHTML = `
                    <span style="color:#fff;">${u.email}</span>
                    <span style="color:var(--primary);">${u.income.toLocaleString()}</span>
                    <span style="color:var(--danger);">${u.expense.toLocaleString()}</span>
                    <span style="font-weight:bold; color:${balance >= 0 ? '#fff' : 'red'}">${balance.toLocaleString()}</span>
                `;
                usersList.appendChild(div);
            });

            document.getElementById('totalSystemMoney').innerText = '$' + totalMoney.toLocaleString();
            document.getElementById('totalUsers').innerText = Object.keys(usersMap).length;
        }
    </script>
</body>
</html>